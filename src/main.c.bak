#include <stdio.h>
#include <string.h>

#include "common.h"
#include "options.h"
#include "utils.h"
#include "lexer.h"
#include "parser.h"
#include "ast.h"
#include "asm_tree.h"

#include "stb_ds.h"
#define STB_DS_IMPLEMENTATION

Lexer *lexer = NULL;

Token *tokens = NULL;
usize tokens_len = 0;

Parser *parser = NULL;

AST *global_ast = NULL;
usize asts_len = 0;

#ifndef NDEBUG
void lexer_log() {
  if (lexer == NULL) {
    fprintf(stderr, "The lexer hasn't been properly initialized\n");
    exit(1);
  }
  printf("LEXER DEBUG\n");
  printf("-----------\n");
  printf("Token list: \n");

  for (int i = 0; i < tokens_len; i++) {
    Token token = tokens[i];
    print_token(&token);
    if (token.type == TOKEN_ERROR || token.type == TOKEN_EOF) {
      break;
    }
  }
}

void parser_log() {
  printf("PARSER DEBUG\n");
  printf("------------\n");
  printf("Program(\n");
  for (int i = 0; i < asts_len; i++) {
    AST ast = global_ast[i];
    printf("    ");
    ast_print(&ast);
    printf("\n");
  }
  printf(")\n");
}

void emit_assembly_log() {
  ASMNode* function = ASMNode_createFunction("main");
  ASMNode* mov_inst = ASMNode_createMov(ASMNode_createImm(42), ASMNode_createRegister(REG_EAX));
  ASMNode_addInstruction(function, mov_inst);
  ASMNode_addInstruction(function, ASMNode_createRet());
  ASMNode* program = ASMNode_createProgram(function);

  // Print the assembly tree
  printf("Assembly Tree:\n");
  print_asm_tree(program, 0);

  // Clean up
  ASMNode_free(program); 
}

#endif

int main(int argc, char **argv) {
  if (argc == 1) {
    printf("higancc: fatal error: no input files\n");
    printf("compilation terminated\n");
    return 1;
  }

  Options opts = Options_parse(argc, argv);

  const char *buffer = read_file(argv[argc-1]);

  lexer = Lexer_init(buffer);
  tokens = Lexer_scanTokens(lexer, &tokens_len);

  parser = Parser_init(tokens);
  global_ast = Parser_parse(parser, &asts_len);

  for (int i = 0; i < tokens_len; i++) {
    Token token = tokens[i];
    if (token.type == TOKEN_ERROR) {
      fprintf(stderr, "[LEXER ERROR - line %d] %.*s\n", token.line, token.length, token.start);
      exit(1);
    }
  }

  if (opts.lexer) {
#ifndef NDEBUG
    lexer_log();
#endif
  }
  if (opts.parser) {
#ifndef NDEBUG
    parser_log();
#endif
  }
  if (opts.emit_assembly) {
#ifndef NDEBUG
    emit_assembly_log();
#endif
  }

  if (opts.output_file) {
    printf("Compile to '%s'\n", opts.output_file);
  }

  arrfree(tokens);
  Lexer_free(lexer);

  arrfree(global_ast);
  Parser_destroy(parser);

  return 0;
}
